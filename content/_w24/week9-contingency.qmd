---
title: "Inference for relative risk and odds ratios"
subtitle: "Analysis of 2x2 contingency tables for data from experimental, prospective, and retrospective study designs"
format: 
  revealjs:
    logo: img/poly-logo-2.jpg
    footer: "STAT218"
    smaller: true
    mermaid:
      theme: neutral
execute: 
  echo: false
  warning: false
  message: false
html-math-method:
  method: mathjax
  url: "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
---

```{r}
library(tidyverse)
library(oibiostat)
library(pander)
library(Sleuth3)
library(epitools)
```

## Today's agenda

1. Discuss final details \[[partner assignments 2pm](https://forms.office.com/r/pbMNAG1GuT)\] \[[partner assignments 4pm](https://forms.office.com/r/G12TfmnUxK)\]
2. [lecture/discussion] relative risk and odds ratios
3. [activity] which analysis? distinguishing study types

## Review: prospective studies

> Prospective-type studies sample from a population and then track participants following exposure/intervention

![Figure: a simple randomized experiment, left; a prospective study, right](img/prospective.png)

- data are a random sample from the study population
- can estimate the probability of the outcome/disease

## Review: retrospective studies

> Retrospective studies sample by outcome and then ascertain exposure

![Figure: a case-control study](img/casecontrol.png)

- data are not a random sample from a population, but instead two distinct samples based on outcome
- *can't* estimate the probability of the outcome of interest (*i.e.*, a case)
- can only estimate proportion of exposures in each group


## From last time: obesity

::: {.columns}

::: {.column}
Researchers recorded deaths due to cardiovascular disease (CVD) among 3,112 obese and non-obese individuals in American Samoa.
```{r}
obesity <- case1801 |> column_to_rownames('Obesity') |> as.matrix() |> as.table()
obesity |> pander()
```

Parameter of interest is a *probability*:

$$p = Pr(\text{CVD death})$$
:::

::: {.column}
Hypotheses:

$$\begin{cases} H_0: p_\text{obese} = p_\text{non-obese} \\ H_A: p_\text{obese} \neq p_\text{non-obese}\end{cases}$$

```{r, echo = T}
prop.test(obesity, alternative = 'two.sided')
```
:::

:::

> The data do not provide sufficient evidence to reject the null hypothesis that the probability of death due to CVD is the same for obese and non-obese Samoans.

## A caveat

```{r, results = 'hide'}
obesity.probs <- prop.test(obesity)$estimate
obesity.probs |> rev() |> diff()
```

Notice that the estimated difference in proportions is very small:
$$\hat{p}_\text{obese} - \hat{p}_\text{non-obese} = 0.00776 - 0.00666 = 0.00110$$

::: {.columns}

::: {.column}

Further:
```{r}
# post-hoc power calculation
power.prop.test(n = 2061, 
                p1 = 0.00776, p2 = 0.00666, 
                sig.level = 0.05, alternative = 'two.sided')
```

So it's highly unlikely that we would detect a difference of this magnitude.
:::

::: {.column}
We may still, therefore, wish to make a comparison of CVD death rates between groups.

- difference in probabilities isn't a helpful comparison
- small difference $\Rightarrow$ hard to interpret
:::

:::

## Relative risk

The **relative risk** provides a more interpretable comparison of outcome probabilities than a raw difference. It is the ratio of probabilities in each group:
$$RR_\text{CVD death} = \frac{p_\text{obese}}{p_\text{non-obese}}
\qquad\left[RR(\text{outcome}) = \frac{Pr(\text{outcome}|\text{exposure})}{Pr(\text{outcome}|\text{non-exposure})}\right]$$

```{r, results = 'hide'}
obesity.rr <- obesity.probs[1]/obesity.probs[2]
obesity.rr
```

For the obesity data:
$$\widehat{RR}_\text{CVD death} = \frac{\hat{p}_\text{obese}}{\hat{p}_\text{non-obese}} = \frac{0.00776}{0.00666} = 1.1656 $$

> It is estimated that obese individuals have a 16.56% higher probability of death due to CVD than non-obese individuals.

## Inference for relative risk: intervals

A normal model can be used to approximate the sampling distribution of the log-RR. This leads to the following confidence interval:

$$\log\left(RR\right) \pm c \times SE\left(\log(RR)\right)
\quad\text{where}\quad SE\left(\log(RR)\right) = \sqrt{\frac{1 - p_1}{p_1n_1} + \frac{1 - p_2}{p_2n_2}}$$

::: {.columns}

::: {.column width="50%"}
```{r, echo = T}
library(epitools)
riskratio(obesity, rev = 'both')[1:2]
```
:::

::: {.column width="50%"}
- critical value $c$ from normal model
- exponentiate for an interval for $RR$

> With 95% confidence, the relative risk of death due to CVD for obese compared with non-obese Samoans is estimated to be between 0.481 and 2.824, with a point estimate of 1.166.
:::

:::

## Inference for relative risk: tests

Using the same model and the test statistic $Z = \frac{\log(RR)}{SE\left(\log(RR)\right)}$ one can test hypotheses:
$$H_0: RR = 1 \quad\text{vs.}\quad H_A: RR\mathrel{\substack{<\\\neq\\>}}1$$

::: {.columns}

::: {.column}

```{r, echo = T}
riskratio(obesity, rev = 'both')[1:3]
```
:::

::: {.column}
In the output, `chi.square` gives the $p$-value. 

> The data (still) do not provide sufficient evidence to reject the null hypothesis that the risk of death due to CVD differs between obese and non-obese Samoans.
:::

:::

```{r, eval =F}
epitools::riskratio(obesity, rev = 'both')
obesity.rr
obesity.rr.se <- sum((1 - obesity.probs)/obesity[, 1]) |> sqrt()
(log(obesity.rr) + 1.96*c(-1, 1)*obesity.rr.se) |> exp()

2*pnorm(log(obesity.rr)/obesity.rr.se, lower.tail = F)
```

## From last time: smoking

::: {.columns}

::: {.column}
Researchers sampled 86 lung cancer patients (cases) and 86 healthy individuals (controls) and recorded smoking status. 
```{r}
smoking <- case1803 |> column_to_rownames('Smoking') |> as.matrix() |> as.table() |> t()
smoking |> pander()
```
- can't estimate $Pr(\text{cancer})$ because of retrospective study design
- limited instead to the proportion of smokers in each group

:::

::: {.column}
We *could* test:

$$\begin{cases} 
H_0: p_\text{cases} = p_\text{controls} \\ 
H_A: p_\text{cases} \neq p_\text{controls}
\end{cases}$$

```{r, echo = T}
prop.test(smoking)
```
:::

:::

> Awkward conclusion: the data provide sufficiently strong evidence to reject the null hypothesis that the proportion of smokers differs between cases and controls.

## Odds ratios

The **odds** of an outcome are defined as:
$$\text{odds}(\text{outcome}) = \frac{Pr(\text{outcome occurs})}{Pr(\text{ouctome does not occur})}$$

If $p = Pr(\text{smoker})$, the odds that an individual is a smoker in each group are:
$$\text{odds}_\text{case}(\text{smoker}) = \frac{p_\text{case}}{1 - p_\text{case}}
\qquad\text{and}\qquad
\text{odds}_\text{control}(\text{smoker}) = \frac{p_\text{control}}{1 - p_\text{control}}$$

The **odds ratio** is defined as:
$$OR_\text{case:control}(\text{smoker}) = 
\frac{\text{odds}_\text{case}(\text{smoker})}{\text{odds}_\text{control}(\text{smoker})}$$

> Interpretation: factor by which odds change between groups.

## Estimating odds ratios

A surprising algebraic fact is that:
$$OR_\text{case:control}(\text{smoker}) = OR_\text{smoker:nonsmoker}(\text{case})$$

::: {.columns}

::: {.column}
To see this suppose $a, b, c, d$ are probabilities:

$\;$ | outcome | non-outcome 
---|---|---
factor | a | b 
non-factor | c | d
:::

::: {.column}
$$\begin{align*}
OR_\text{outcome:non-outcome}(\text{factor}) = \frac{a/c}{b/d} = \frac{ad}{bc} \\
OR_\text{factor:non-factor}(\text{outcome}) = \frac{a/b}{c/d} = \frac{ad}{bc}
\end{align*}$$
:::

:::

> So we can estimate the ratio of the odds *of cancer* by smoking status using the ratio of the odds of smoking by cancer status!

## Estimating odds ratios

::: {.columns}

::: {.column}
Let $p$ denote $Pr(\text{smoker})$ as before and:

- $\hat{p}_\text{case}$ : proportion of smokers in the lung cancer group
- $\hat{p}_\text{control}$ : proportion of smokers in the control group
:::

::: {.column}
```{r}
smoking |> pander()
```
:::

:::

An estimate of the odds ratio for cancer between case and control groups is:
$$\widehat{OR}_\text{smoker:nonsmoker}(\text{cancer}) = \frac{\hat{p}_\text{case}}{1 - \hat{p}_\text{case}} \times \frac{1 - \hat{p}_\text{control}}{\hat{p}_\text{control}} = \frac{83}{3} \times \frac{14}{72} = 5.38$$

> It is estimated that the odds of lung cancer are 5.38 times greater for smokers compared with nonsmokers.

## Inference for odds ratios: intervals

The sampling distribution of the log odds ratio can be approximated by a normal model.

$$\log(OR) \pm c \times SE(\log(OR)) 
\quad\text{where}\quad
SE(\log(OR)) = \sqrt{\frac{1}{n_{11}} + \frac{1}{n_{12}} + \frac{1}{n_{21}} + \frac{1}{n_{22}}}$$

Above, $n_{ij}$ denotes the count in the $ij$th position in the contingency table.

::: {.columns}

::: {.column}
```{r, echo = T}
oddsratio(smoking, rev = 'both', 
          method = 'wald')[1:2]
```
:::

::: {.column}
- critical value $c$ from the normal model
- exponentiate to obtain an interval for $OR$

> With 95% confidence, the odds of lung cancer are estimated to be between 1.58 and 24.02 times greater for smokers compared with nonsmokers.
:::

:::

## Inference for odds ratios: tests

Using the same model and the test statistic $Z = \frac{\log(OR)}{SE\left(\log(OR)\right)}$ one can test hypotheses:
$$H_0: OR = 1 \quad\text{vs.}\quad H_A: OR\mathrel{\substack{<\\\neq\\>}}1$$

::: {.columns}

::: {.column}

```{r, echo = T}
oddsratio(smoking, rev = 'both')[1:3]
```
:::

::: {.column}
In the output, `chi.square` gives the $p$-value. 

> The data provide sufficiently strong evidence to reject the null hypothesis that the odds of lung cancer are the same for smokers and nonsmokers.
:::

:::

## Summing up

For prospective studies and randomized experiments:

- outcome probabilities can be estimated directly
- inference should concern relative risk

For retrospective and case-control studies:

- outcome probabilities **cannot** be estimated directly
- inference should concern odds ratio

