---
title: "Lab 14: Inference for relative risk and odds ratios"
author: "STAT218"
author-title: "Course activity"
execute: 
  echo: false
  eval: true
  message: false
  warning: false
  results: 'markup'
format: 
  html:
    toc: true
  docx:
    toc: false
prefer-html: true
embed-resources: true
---

```{r load packages}
library(tidyverse)
library(oibiostat)
library(epitools)
library(openintro)
library(Sleuth3)
library(pander)
```

This activity focuses on inference of relative risk and odds ratios. There are three objectives:

1. Learn to perform tests and compute interval estimates for relative risk
2. Learn to perform tests and compute interval estimates for odds ratios
3. Practice discerning which estimand is appropriate given study design

Note that *you cannot determine* the study design from inspecting the data.

## Examples

### Relative risk

Researchers recorded deaths due to cardiovascular disease (CVD) among a random sample of 3,112 individuals in American Samoa, where obesity was considered socially desirable, in order to investigate a potential link between obesity and CVD mortality.

```{r obesity data}
obesity <- case1801 |> column_to_rownames('Obesity') |> as.matrix() |> as.table()
obesity |> pander()
```

Because the data are a random sample from the population of interest (Samoans), it is possible to estimate the probability of the outcome of interest.

- the outcome of interest is death due to CVD
- the groups are obese and non-obese individuals
- this is a prospective-type observational study
- relative risk is a more appropriate target for inference

Therefore we'll perform inference on:
$$RR_\text{obese:non-obese}(\text{CVD death}) = \frac{Pr_\text{obese}(\text{CVD death})}{Pr_\text{non-obese}(\text{CVD death})}$$

In R, this is a one-line command:
```{r estimating risk ratio, echo = T}
riskratio(obesity, rev = 'both')
```
The `riskratio` function has a specific formatting requirement: 

- rows should be ordered so that the reference/control group appears first
- columns should be ordered so that the outcome of interes appears second

The `rev = ...` argument *reverses* the order of rows, columns, or both.

- `rev = 'neither'` (default) indicates order of rows and columns is correctly specified
- `rev = 'rows'` reverses the order of rows only
- `rev = 'columns'` reverses the order of columns only
- `rev = 'both'` reverses the order of rows and columns

In the example, `rev = 'both'` is used because the contingency table shows non-obese individuals (reference group) in the second row and deaths (outcome of interest) in the first column. Both should be reversed.

### Odds ratio

Researchers sampled 86 lung cancer patients (cases) and 86 healthy individuals (controls) and recorded smoking status. 
```{r smoking data}
smoking <- case1803 |> column_to_rownames('Smoking') |> as.matrix() |> as.table() |> t()
smoking |> pander()
```

This is a case-control study and inherently retrospective, because the outcome of interest is developing lung cancer, but individuals are sampled based on outcome and the risk factor (smoking) is identified retrospectively. 

- the outcome of interest is lung cancer
- the groupings are smokers and nonsmokers
- the study design is retrospective
- odds ratio is the more appropriate target for inference

In this case it is not possible to estimate the probability of the outcome of interest, so inference should focus on the odds ratio:

$$OR_\text{smoker:nonsmoker}(\text{cancer}) = \frac{\text{odds}_\text{smoker}(\text{cancer})}{\text{odds}_\text{nonsmoker}(\text{cancer})}$$

This, as well, is a one-line command in R:
```{r estimating odds ratio}
oddsratio(smoking, rev = 'both', method = 'wald')
```

The `oddsratio` function expects the same input format: the first row is the reference/control group, and the second column is the outcome of interest.

## Practice problems

1. An outbreak of cyclosporiasis was detected among residents of New Jersey. In a case-control study, investigators found that 21 of 30 case-patients and four of 60 controls had eaten raspberries.

    a. Identify the outcome of interest and groupings.
    b. Identify the study design.
    c. Based on the study design, is the odds ratio or relative risk a more appropriate inferential target?
    d. Perform inference according to your answer in (c); carry out a test and compute a confidence interval.

```{r practice problem 1}
cyclo <- matrix(data = c(21, 4, 9, 56), 
               nrow = 2, 
               byrow = T, 
               dimnames = list(raspberries = c('yes', 'no'),
                               cyclosporiasis = c('yes', 'no'))
                )

cyclo |> pander()
```

2. Researchers conducted a prospective cohort study of 3,000 smokers and 5,000 nonsmokers to investigate the relationship between smoking and the development of coronary heart disease (CHD) over 1 year.

    a. Identify the outcome of interest and groupings.
    b. Identify the study design.
    c. Based on the study design, is the odds ratio or relative risk a more appropriate inferential target?
    d. Perform inference according to your answer in (c); carry out a test and compute a confidence interval.

```{r practice problem 2}
chd <- matrix(data = c(84, 2916, 87, 4913), 
               nrow = 2, 
               byrow = T, 
               dimnames = list(smoker = c('yes', 'no'),
                               chd = c('yes', 'no'))
                )

chd |> pander()
```


3. Researchers gave 48 male bank supervisors attending a management institute hypothetical personnel files and asked them whether they would promote the applicant based on the file. The personnel files were identical except that 24 of them listed a male and 24 listed a female applicant. The assignment of managers to receive either a male or female applicant file was carried out at random.

    a. Identify the outcome of interest and groupings.
    b. Identify the study design.
    c. Based on the study design, is the odds ratio or relative risk a more appropriate inferential target?
    d. Perform inference according to your answer in (c); carry out a test and compute a confidence interval.

```{r practice problem 3}
case1901 |> pander()
```

4. The Learning Early About Peanut allergy (LEAP) study recruited 530 children with risk factors for developing peanut allergies and randomly allocated peanut exposure and peanut avoidance regimens to each participant. At 5 years of age, an oral food challenge (OFC) test was administered to determine whether participants had developed allergies.

    a. Identify the outcome of interest and groupings.
    b. Identify the study design.
    c. Based on the study design, is the odds ratio or relative risk a more appropriate inferential target?
    d. Perform inference according to your answer in (c); carry out a test and compute a confidence interval.

```{r practice problem 4}
data("LEAP")
leap <- xtabs(~ overall.V60.outcome + treatment.group, data = LEAP)
leap |> pander()
```

5. A 30-year study to investigate the effectiveness of mammograms versus a standard non-mammogram breast cancer exam was conducted in Canada with 89,835 female participants.12 During a 5-year screening period, each woman was randomized to either receive annual mammograms or standard physical exams for breast cancer. During the 25 years following the screening period, each woman was screened for breast cancer according to the standard of care at her health care center. At the end of the 25 year follow-up period, 1,005 women died from breast cancer. The results by intervention are summarized in `mammogram`.

    a. Identify the outcome of interest and groupings.
    b. Identify the study design.
    c. Based on the study design, is the odds ratio or relative risk a more appropriate inferential target?
    d. Perform inference according to your answer in (c); carry out a test and compute a confidence interval.

```{r practice problem 5}
mammogram <- matrix(data = c(500, 44425, 505, 44405), 
               nrow = 2, 
               byrow = T, 
               dimnames = list(mammogram = c('yes', 'no'),
                               cancer.death = c('yes', 'no'))
                )
mammogram |> pander()
```

6. An observational study of 227,571 Medicare beneficiaries who initiated treatment with one of two diabetes medications recorded whether each patient reported cardiovascular problems. 

    a. Identify the outcome of interest and groupings.
    b. Identify the study design.
    c. Based on the study design, is the odds ratio or relative risk a more appropriate inferential target?
    d. Perform inference according to your answer in (c); carry out a test and compute a confidence interval.

```{r practice problem 6}
diabetes <- avandia |> table()
diabetes |> pander()
```

7. On March 31, 2021, Pfizer and BioNTech announced that "in a Phase 3 trial in adolescents 12 to 15 years of age with or without prior evidence of SARS-CoV-2 infection, the Pfizer-BioNTech COVID-19 vaccine BNT162b2 demonstrated 100% efficacy and robust antibody responses, exceeding those recorded earlier in vaccinated participants aged 16 to 25 years old, and was well tolerated." These results are from a Phase 3 trial in 2,260 adolescents 12 to 15 years of age in the United States. In the trial, 18 cases of COVID-19 were observed in the placebo group (n = 1,129) versus none in the vaccinated group (n = 1,131).

    a. Identify the outcome of interest and groupings.
    b. Identify the study design.
    c. Based on the study design, is the odds ratio or relative risk a more appropriate inferential target?
    d. Perform inference according to your answer in (c); carry out a test and compute a confidence interval.

```{r practice problem 7}
vaccine <- biontech_adolescents |> table()
vaccine |> pander()
```

8. A random sample of 1629 U.S. adults obtained from NHANES data was used to investigate whether asthma is more common in women than in men.

    a. Identify the outcome of interest and groupings.
    b. Identify the study design.
    c. Based on the study design, is the odds ratio or relative risk a more appropriate inferential target?
    d. Perform inference according to your answer in (c); carry out a test and compute a confidence interval.

```{r practice problem 8}
asthma <- matrix(data = c(49, 781, 30, 769), 
               nrow = 2, 
               byrow = T, 
               dimnames = list(sex = c('female', 'male'),
                               asthma = c('yes', 'no'))
                )
asthma |> pander()
```