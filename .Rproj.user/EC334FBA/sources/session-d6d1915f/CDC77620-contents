---
title: "Two sample inference"
subtitle: "Hypothesis tests and intervals for comparing means from paired and independent data"
format: 
  revealjs:
    logo: img/poly-logo-2.jpg
    footer: "STAT218"
    smaller: true
    mermaid:
      theme: neutral
execute: 
  echo: false
  warning: false
  message: false
---

## Today's agenda

```{r}
library(tidyverse)
library(oibiostat)
library(Sleuth3)
library(pander)
```

1.  Reading quiz \[[2pm section](https://forms.office.com/r/f81B2eHCv7)\] \[[4pm section](https://forms.office.com/r/1HiaaNEXCG)\]
2.  [lecture/lab] Two-sample inference for population means
    
    a. Paired data
    b. Independent data
    
3.  [if time] Introduction to power analysis

## From last time

> Are swimmers faster in bodysuits than in regular swimsuits?

Below are the first few observations of the average velocity of competitive swimmers in a 1500m; one measurement was taken in a swimsuit, the other in a bodysuit.

```{r}
data(swim)
swim <- swim %>%
  transmute(swimmer = swimmer.number,
            body.suit.velocity = wet.suit.velocity,
            swim.suit.velocity = swim.suit.velocity)
swim %>% head(3) %>% pander()
```

-   *two-sample* problem because there are two sets of observations
-   observations are **paired** by swimmer

This is the easiest kind of two-sample problem because we can reduce it to a one-sample problem by performing inference on paired differences.

## Inference for paired data

1.  Calculate paired differences.

```{r}
diffs <- swim$body.suit.velocity - swim$swim.suit.velocity
swim$velocity.diff <- diffs
swim %>% head(3) %>% pander
```

::: columns
::: column
2.  Perform test as before.

```{r, echo = T}
# test for paired difference
t.test(diffs, mu = 0, alternative = 'greater')
```
:::

::: column
3.  Report the result of the test. *You try.*
:::
:::

## Formulating a two-sample problem

::: columns
::: {.column width="60%"}
Two-sample problems are characterized by:

-   one variable of interest
-   two groups of observations
-   objective to compare group means

Inference concerns the *difference in means*

$$\delta = \mu_1 - \mu_2$$

We just tested:

$$H_0: \mu_\text{body} \leq \mu_\text{swim}$$ $$H_A: \mu_\text{body} > \mu_\text{swim}$$
:::

::: {.column width="40%"}
Rearranging the data to emphasize two-sample problem structure:

```{r}
swim_long <- swim %>%
  transmute(swimmer = swimmer,
            body = body.suit.velocity,
            swim = swim.suit.velocity) %>%
  pivot_longer(c(body, swim), 
               names_to = 'suit', 
               values_to = 'velocity') 
swim_long %>%
  head(5) %>%
  pander()
```

-   variable of interest: `velocity`
-   grouping: `suit`
-   pairing: `swimmer`
:::
:::

## Hypotheses for two-sample tests

We can articulate two-sided and directional tests for the difference in means $\delta = \mu_1 - \mu_2$ and the corresponding interpretation in terms of the group means.

::: columns
::: column
**Difference in means**

$$\text{two-sided}\begin{cases} H_0: \delta \qquad 0 \\ H_A: \delta \qquad 0 \end{cases}$$

$$\text{lower-sided}\begin{cases} H_0: \delta \qquad 0 \\ H_A: \delta \qquad 0 \end{cases}$$

$$\text{upper-sided}\begin{cases} H_0: \delta \qquad 0 \\ H_A: \delta \qquad 0 \end{cases}$$
:::

::: column
**Group interpretation**

$$\begin{cases} H_0: \mu_1 \qquad \mu_2 \\ H_A: \mu_1 \qquad \mu_2 \end{cases}$$

$$\begin{cases} H_0: \mu_1 \qquad \mu_2 \\ H_A: \mu_1 \qquad \mu_2 \end{cases}$$

$$\begin{cases} H_0: \mu_1 \qquad \mu_2 \\ H_A: \mu_1 \qquad \mu_2 \end{cases}$$
:::
:::

## Your turn: FAMuSS

> Does resistance training lead to greater strength gains on the nondominant arm?

```{r}
data(famuss)

head(famuss, 3) %>% pander()
```

Articulate and test an appropriate hypothesis for $\delta = \mu_\text{ndrm} - \mu_\text{drm}$

::: columns
::: {.column width="40%"}
-   Hypotheses: $$H_0: \hspace{15cm}$$ $$H_A: \hspace{15cm}$$
:::

::: {.column width="60%"}
-   Result:
:::
:::

## Evolution of Darwin's finches

::: columns
::: {.column width="70%"}
> Grant, P. (1986). Ecology and Evolution of Darwin's Finches, Princeton University Press, Princeton, N.J.

Peter and Rosemary Grant caught and measured all the birds from more than 20 generations of finches on the Galapagos island of Daphne Major.

-   severe drought in 1977 limited food to large tough seeds

-   selection pressure favoring larger and stronger beaks

-   hypothesis: beak depth increased in 1978 relative to 1976

*How do we test for a difference in the absence of pairing?*
:::

::: {.column width="30%"}
Finch beak data:

```{r}
finch <- case0201
finch %>%
  group_by(Year) %>%
  sample_n(size = 3) %>%
  pander()
```

-   Variable: `Depth`
-   Grouping: `Year`
-   *No pairing!*
:::
:::

## Inference for independent data

> Beak depths exemplify **independent data**: the groups of observations are unrelated.

::: columns
::: column
Inference is based on the difference in group means:

$$
T = \frac{\bar{x} - \bar{y}}{SE(\bar{x} - \bar{y})}
$$

-   $\bar{x}, \bar{y}$ are groupwise sample means
-   $SE(\bar{x} - \bar{y}) = \sqrt{\frac{s_x^2}{n_x} + \frac{s_x^2}{n_y}}$
-   degrees of freedom for $t$ model are approximated
:::

::: column
$$H_0: \mu_{1976} \geq \mu_{1978}$$ $$H_A: \mu_{1976} < \mu_{1978}$$

```{r, echo = T}
t.test(Depth ~ Year, data = finch,
       mu = 0, alternative = 'less')
```
:::
:::

## Two input formats

```{r}
depth76 <- filter(finch, Year == 1976) %>% pull(Depth)
depth78 <- filter(finch, Year == 1978) %>% pull(Depth)
```

::: columns
::: column
The **formula** format takes inputs:

1.  an R formula
2.  a data frame

```{r, echo = T}
# two-sample test (formula inputs)
t.test(Depth ~ Year, data = finch,
       mu = 0, alternative = 'less')
```

`Depth ~ Year`: "depth *depends on* year"
:::

::: column
The **vector** format takes inputs:

1.  vector of observations for one group
2.  vector of observations for the other group

```{r, echo = T}
# two-sample test (vector inputs)
t.test(depth76, depth78,
       mu = 0, alternative = 'less')
```
:::
:::

## Interpreting results

::: columns
::: {.column width="45%"}
```{r, echo = F}
out <- t.test(Depth ~ Year, data = finch,
       mu = 0, alternative = 'less')
out
```

To report the results:

1.  State conclusion
2.  Interpret test result in context
3.  Report statistics (*T*, *df*, *p*-value)
4.  Provide point estimates

*Careful about signs and directions!*
:::

::: {.column width="55%"}
> Our findings suggest finch beak depth on Daphne Major increased as a result of natural selection following drought. The data provide strong evidence against the null hypothesis that mean beak depth remained comparable or diminished in the generation following the drought in favor of the alternative that mean beak depth increased (*T* = -4.58 on 172.98 degrees of freedom, *p* = 0.00000437). With 95% confidence, the increase in beak depth is estimated to be at least 0.427 mm, with a point estimate of 0.669 mm (*SE* = `r round(out$std, 4)`).
:::
:::

## Cloud data: paired or independent?

> Does dropping silver iodide onto clouds increase rainfall?

::: columns
::: {.column width="60%"}
Data are rainfall measurements in a target area from 26 days when clouds were seeded and 26 days when clouds were not seeded.

-   `rainfall` gives volume of rainfall in acre-feet
-   `treatment` indicates whether clouds were seeded

Hypotheses to test: $$H_0: \mu_\text{seeded} \quad \mu_\text{unseeded}$$ $$H_A: \mu_\text{seeded} \quad \mu_\text{unseeded}$$
:::

::: {.column width="40%"}
```{r}
cloud <- case0301 %>% rename_with(tolower)
cloud %>%
  group_by(treatment) %>%
  sample_n(size = 4) %>%
  pander()
```
:::
:::

## Sleep drugs: paired or independent?

> Which (if either) of two soporific drugs is more effective?

::: columns
::: {.column width="60%"}
Data are extra hours of sleep for 10 study participants when taking each of two drugs.

-   `extra.sleep` gives hours of additional sleep relative to control
-   `drug` indicates which sleep drug was taken
-   `subject` indicates study participant id

Hypotheses to test: $$H_0: \mu_1 \quad \mu_2$$ $$H_A: \mu_1 \quad \mu_2$$
:::

::: {.column width="40%"}
```{r}
rename(sleep, extra.sleep = extra, drug = group, subject = ID) %>%
  arrange(subject) %>%
  slice_head(n = 6) %>%
  pander()
```
:::
:::


## Test assumptions

::: columns
::: {.column width="40%"}
Inference relies on a $t$ model providing a good approximation to the sampling distribution. This requires three assumptions:

1.  variable of interest is numeric and not too discrete

2.  observations are independent (besides pairing)

3.  either:

    a.  sample sizes are not too small
    b.  or distribution(s) are symmetric and unimodal
:::

::: {.column width="60%"}
Common issues:

| Issue                                                             | Consequence                                                        |
|------------------------------------|------------------------------------|
| Highly discrete data                                              | $t$ model not appropriate                                          |
| Dependent observations                                            | $SE$ is a biased estimate: nominal error rates and coverage are inaccurate |
| Small samples with [*heavy*]{.underline} skew or [*extreme*]{.underline} outliers | $SE$ too small: inflated type I error and under-coverage           |

> *In each of these scenarios, different inference procedures should be used.*

:::
:::

```{r, eval = F}
sim_out <- sapply(1:10000, function(i){t.test(rexp(7, rate = 1/10), mu = 10)$p.value})
hist(sim_out, breaks = 100)
mean(sim_out < 0.05)
```

## Power calculations

> How much data do you need to collect in order to detect a difference of $\delta$?

::: {.columns}

::: {.column width="55%"}
The statistical **power** of a test captures how often it detects a specified alternative.

- defined as $\beta = (1 - \text{type II error rate})$
- measures how often the test correctly rejects
- value depends on...

    a. magnitude of difference between null value and true value of parameter
    b. significance level
    c. sample size

:::

::: {.column width="45%"}
```{r, echo=T}
power.t.test(power = 0.95, 
             delta = 0.5, 
             sig.level = 0.05, 
             type = 'two.sample',
             alternative = 'two.sided')
```
$\Rightarrow$ need 105 observations in each group to detect a difference of 0.5 standard deviations at level 0.05 with type II error rate 5% or less
:::

:::

## The equal-variance $t$-test

If it is reasonable to assume the (population) standard deviations are the same in each group, one can gain a bit of power (lower type II error rate) by using a different standard error:

$$SE_\text{pooled}(\bar{x} - \bar{y}) = \sqrt{\frac{\color{red}{s_p^2}}{n_x} + \frac{\color{red}{s_p^2}}{n_y}}
\quad\text{where}\quad \color{red}{s_p} = \underbrace{\sqrt{\frac{(n_x - 1)s_x^2 + (n_y - 1)s_y^2}{n_x + n_y - 2}}}_{\text{weighted average of } s_x^2 \;\&\; s_y^2}$$

Implement by adding `var.equal = T` as an argument to `t.test()`.

- larger df is used, hence more frequent rejections
- avoid unless you have a small sample

